%%
%% This is file `dramatist.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% dramatist.dtx  (with options: `dramatist')
%% 
%% IMPORTANT NOTICE:
%% 
%% For the copyright see the source file.
%% 
%% Any modified versions of this file must be renamed
%% with new filenames distinct from dramatist.sty.
%% 
%% For distribution of the original source see the terms
%% for copying and modification in the file dramatist.dtx.
%% 
%% This generated file may be distributed as long as the
%% original source files, as listed above, are part of the
%% same distribution. (The sources need not necessarily be
%% in the same archive or directory.)
%% dramatist.dtx
%% Copyright (C) 2003-2005 Massimiliano Dominici
%% \CharacterTable%%  {Upper-case    \A\B\C\D\E\F\G\H\I\J\K\L\M\N\O\P\Q\R\S\T\U\V\W\X\Y\Z
%%   Lower-case    \a\b\c\d\e\f\g\h\i\j\k\l\m\n\o\p\q\r\s\t\u\v\w\x\y\z
%%   Digits        \0\1\2\3\4\5\6\7\8\9
%%   Exclamation   \!     Double quote  \"     Hash (number) \#
%%   Dollar        \$     Percent       \%     Ampersand     \&
%%   Acute accent  \'     Left paren    \(     Right paren   \)
%%   Asterisk      \*     Plus          \+     Comma         \,
%%   Minus         \-     Point         \.     Solidus       \/
%%   Colon         \:     Semicolon     \;     Less than     \<
%%   Equals        \=     Greater than  \>     Question mark \?
%%   Commercial at \@     Left bracket  \[     Backslash     \\
%%   Right bracket \]     Circumflex    \^     Underscore    \_ Grave accent  \`
%%       Left brace    \{     Vertical bar  \| Right brace   \}     Tilde
%%     \~}
%%
\RequirePackage{svn-prov}
\ProvidesPackageSVN{$Id$}[v1.99][Package for typesetting drama]
\NeedsTeXFormat{LaTeX2e}
\RequirePackage{xspace}
\RequirePackage{xkeyval}
\RequirePackage{ifmtarg}
\RequirePackage{etoolbox}
\newcommand\DR@define@key[4]{% <id><fam><key><default>
  \ifx#1c%
    \DR@define{command}{#2}{#3}{#4}%
  \else%
    \ifx#1l%
      \DR@define{length}{#2}{#3}{#4}%
    \else%
      \ifx#1b%
        \DR@define{bool}{#2}{#3}{#4}%
      \else%
        \ifx#1L%
          \DR@define{glength}{#2}{#3}{#4}%
        \fi%
      \fi%
    \fi%
  \fi%
}
\newcommand\DR@define[1]{\csname DR@define@#1key\endcsname}
\newcommand\DR@define@commandkey[3]{%
  \define@cmdkey{#1}[DR@#1@]{#2}[#3]{}%
}
\newcommand\DR@define@lengthkey[3]{%
  \expandafter\newlength\csname DR@#1@#2\endcsname
  \define@key{#1}{#2}[#3]{%
    \expandafter\setlength\csname DR@#1@#2\endcsname{##1}
}%
}
\newcommand\DR@define@glengthkey[3]{%
  \expandafter\newlength\csname DR@#1@#2\endcsname
  \define@cmdkey{#1}[DR@#1@]{#2}[#3]{
    \global\expandafter\setlength\csname DR@#1@#2\endcsname{##1}
  }%
}
\newcommand\DR@define@boolkey[3]{%
  \define@boolkey+{#1}[DR@#1@]{#2}[#3]{}{%
    \PackageWarning{dramatist}{Invalid input for key `#2' in family `#1'}}%
}
\newcommand\DR@define@defaults[2]{%
  \expandafter\def\csname default@#1\endcsname{#2}
}
\newcommand\DR@setvalues[1]{%
  \csname default@#1\endcsname%
  \csname setup@#1\endcsname%
}
%%----------------------------------------------------------------------
%% Public Tools
\newcommand\DRSetup[3]{% <name><fam><spec>
  \expandafter\appto\csname setup@#1\endcsname{%
    \presetkeys{#2}{#3}{}%
    \setkeys{#2}{}%
    }%
}
\newcommand\NewStyle[2]{% <name><code>
  \expandafter\def\csname DR@style@#1\endcsname{#2}
}
\newcommand\ApplyStyle[1]{%
  \csname DR@style@#1\endcsname
}
%%----------------------------------------------------------------------
\@ifundefined{if@openright}{\newif\if@openright}{}
\newif\if@cglist
\newif\if@drverse
\newif\if@poemscol
\newif\if@stagedir
\newif\if@firstdirection
\def\DRroman#1{\expandafter\romannumeral\csname c@#1\endcsname}
\def\DR@roman#1{\romannumeral #1}
\newcommand\DR@linenumberwarning{}
\newcommand\DR@setlinenumber{%
  \setcounter{storelineno}{0}
  \if@poemscol
    \setcounter{storeprintlineindex}{0}
  \else
    \refstepcounter{storelineno}
  \fi
}
\def\actname{Act}
\def\scenename{Scene}
\def\drampername{Dramatis Person\ae}
\def\DR@lnpa{}
\def\DR@lnps{}
\define@choicekey+{dramatist.sty}{numbering}[\val\nr]{document,act,scene}{%
  \renewcommand\DR@linenumberwarning{\PackageWarning{dramatist}{\DR@lnpwarning}}
  \ifcase\nr\relax
  \or
    \let\DR@lnpa\DR@setlinenumber
  \or
    \let\DR@lnps\DR@setlinenumber
  \fi
}{\PackageWarning{dramatist}{Invalid input `##1' for option `##2'}}
\define@key{dramatist.sty}{style}[modern]{%
  \def\DR@stylefile{#1}
}
\ExecuteOptionsX{style}
\ProcessOptionsX
\newcounter{storelineno}
\setcounter{storelineno}{0}
\if@poemscol\else
\refstepcounter{storelineno}\fi
\newcounter{storeprintlineindex}
\newcounter{character}
\newcounter{act}
\newcounter{scene}[act]
\renewcommand{\theact}{\roman{act}}
\renewcommand{\thescene}{\roman{scene}}
\newlength\verse@leftmargin
\setlength\verse@leftmargin{\leftmarginii}
%%----------------------------------------------------------
%% Drama
\DR@define@key{l}{drama}{leftmargin}{0pt}
\DR@define@key{l}{drama}{rightmargin}{0pt}
\DR@define@key{l}{drama}{speakswidth}{0pt}
\DR@define@key{l}{drama}{speaksindent}{0pt}
\DR@define@key{l}{drama}{speechskip}{0pt}
\DR@define@key{l}{drama}{parsep}{0pt}
\DR@define@key{l}{drama}{labelsep}{0pt}
\DR@define@key{c}{drama}{speakerlabel}{}
\DR@define@key{c}{drama}{font}{}
\DR@define@key{c}{drama}{postitem}{}

\newenvironment{DR@drama@prose}{%
  \@firstdirectiontrue
  \let\DR@pidefault\DR@drama@postitem
  \DR@linenumberwarning%
    \list{}{%
      \leftmargin\DR@drama@leftmargin%
      \rightmargin\DR@drama@rightmargin%
      \labelwidth\DR@drama@speakswidth%
      \itemindent\DR@drama@speaksindent%
      \itemsep\DR@drama@speechskip%
      \parsep\DR@drama@parsep%
      \labelsep\DR@drama@labelsep%
    }%
    \DR@drama@font%
    }{\endlist}

\newenvironment{drama}[1][]{%
  \DR@setvalues{drama}
  \setkeys{drama}{#1}
  \DR@drama@prose}{\endDR@drama@prose}

\newenvironment{DR@drama@verse}{%
  \let\DR@pidefault\DR@drama@postitem%
  \list{}{%
      \leftmargin=\dimexpr-\verse@leftmargin+\DR@drama@leftmargin\relax%
      \rightmargin\DR@drama@rightmargin%
      }%
  \item\relax%
    \@drversetrue%
    \if@poemscol%
    \typeout{\the\verse@leftmargin}
        \begin{poem}%
        \setcounter{verselinenumber}{\value{storelineno}}%
        \setcounter{printlineindex}{\value{storeprintlineindex}}%
    \else%
        \begin{verse}%
    \fi%
    \ifx\@vsifbang\@undefined\else%
        \setcounter{poemline}{\value{storelineno}}%
    \fi%
    \DR@drama@font%
    \vspace{-\dimexpr\parsep+\partopsep\relax}%
    }{%
    \ifx\@vsifbang\@undefined\else
        \setcounter{storelineno}{\value{poemline}}
    \fi
    \if@poemscol
        \end{poem}
        \setcounter{storelineno}{\value{verselinenumber}}
        \setcounter{storeprintlineindex}{\value{printlineindex}}
    \else
        \end{verse}
    \fi
    \@drversefalse
  \endlist
}
\newenvironment{versedrama}[1][]{%
  \DR@setvalues{versedrama}%
  \setkeys{drama}{#1}%
  \DR@drama@verse}{\endDR@drama@verse}
\expandafter\def\csname drama*\endcsname{\versedrama}
\expandafter\def\csname enddrama*\endcsname{\endversedrama}

%%------------------------------------------------------------------------
%% Document divisions
\DR@define@key{c}{sections}{namefont}{}
\DR@define@key{c}{sections}{numfont}{\DR@sections@namefont}
\DR@define@key{c}{sections}{titlefont}{}
\DR@define@key{c}{sections}{name}{}
\DR@define@key{c}{sections}{sep}{ -- }
\DR@define@key{c}{sections}{pagestyle}{empty}
\DR@define@key{l}{sections}{beforeskip}{0pt}
\DR@define@key{l}{sections}{afterskip}{0pt}

\providecommand\phantomsection{}
\newcommand\actmark[1]{}
\newcommand{\printactname}{\centering\DR@sections@namefont \DR@sections@name}
\newcommand{\printactnum}{\DR@sections@numfont \theact}
\newcommand{\printacttitle}[1]{\DR@sections@titlefont\ #1}
\newcommand{\printsep}{\ }
\def\actheadstart{\vspace*{\DR@sections@beforeskip}}
\def\afteract{\par\nobreak\vskip\DR@sections@afterskip}
\newcommand\@openact{%
    \@ifundefined{if@openright}{\clearpage}{%
        \if@openright
            \clearpage{\thispagestyle{empty}\cleardoublepage}
        \else
            \clearpage
        \fi}
    \thispagestyle{\DR@sections@pagestyle}
    \refstepcounter{act}
    \DR@lnpa
}
\newcommand\act{%
    \@openact
    \secdef\@act\@sact}
\newcommand\@act[1][]{%
    {\phantomsection
    \DR@setvalues{act}
    \addcontentsline{toc}{chapter}{\DR@sections@name\ \theact}
    \actmark{\DR@sections@name\ \theact}
    \m@ke@cthead{#1}
    \@afterindentfalse
    \@afterheading}}
\newcommand\@sact[1][]{%
    \m@ke@cthead{#1}
    \@afterindentfalse
    \@afterheading}
\newcommand\Act{%
    \@openact
    \secdef\@Act\@sact}
\def\@Act[#1]#2{%
    {\phantomsection
    \DR@setvalues{act}
    \ifnum\c@secnumdepth>\m@ne
        \addcontentsline{toc}{chapter}{\DR@sections@name\ \theact\ #1}
    \else
        \addcontentsline{toc}{chapter}{#1}
    \fi
    \actmark{\DR@sections@name\ \theact\ #1}
    \m@ke@cthead{#2}
    \@afterindentfalse
    \@afterheading}}
\newcommand\m@ke@cthead[1]{%
    \actheadstart
    \parindent \z@
    \ifnum\c@secnumdepth>\m@ne
        \printactname \printsep \printactnum
    \fi
        \printacttitle{#1}
    \afteract
}
\newcommand\scenemark[1]{}
\newcommand{\printscenename}{\centering\DR@sections@namefont \DR@sections@name}
% \newcommand{\printscenenum}{\DR@sections@numfont \theact\DR@sections@sep\thescene}
\newcommand{\printscenenum}{\DR@sections@numfont \thescene}
\newcommand{\printscenetitle}[1]{\DR@sections@titlefont\ #1}
\def\sceneheadstart{\vspace*{\DR@sections@beforeskip}}
\def\afterscene{\par\nobreak\vskip\DR@sections@afterskip}
\newcommand\@openscene{%
    \stepcounter{scene}
    \DR@lnps
}
\newcommand\scene{%
    \@openscene
    \secdef\@scene\@sscene}
\newcommand\@scene[1][]{%
    {\phantomsection
    \DR@setvalues{scene}
    \addcontentsline{toc}{section}{\DR@sections@name\ \thescene}
    \scenemark{\DR@sections@name\ \thescene}
    \m@kescenehead{#1}
    \@afterindentfalse
    \@afterheading}}
\newcommand\@sscene[1][]{%
    \m@kescenehead{#1}
    \@afterindentfalse
    \@afterheading}
\newcommand\Scene{%
    \@openscene
    \secdef\@Scene\@sscene}
\def\@Scene[#1]#2{%
    {\phantomsection
    \DR@setvalues{scene}
    \ifnum\c@secnumdepth>\z@
        \addcontentsline{toc}{section}{\DR@sections@name\ \thescene\ #1}
    \else
        \addcontentsline{toc}{section}{#1}
    \fi
    \scenemark{\DR@sections@name\ \thescene\ #1}
@kescenehead{#2}
    \@afterindentfalse
    \@afterheading}}
\newcommand\m@kescenehead[1]{%
    \sceneheadstart
    \parindent \z@
    \ifnum\c@secnumdepth>\z@
        \printscenename \printsep \printscenenum
    \fi
    \printscenetitle{#1}
    \afterscene
}
%%----------------------------------------------------------------------------------
%% Characters
\DR@define@key{c}{character}{dirname}{\DR@character@speakername}
\DR@define@key{c}{character}{speakername}{}
\DR@define@key{c}{character}{role}{\DR@character@speakername}
\DR@define@key{c}{character}{desc}{}
\DR@define@key{c}{character}{actor}{}
\DR@define@key{c}{character}{rdsep}{}
\DR@define@key{c}{character}{speaksadd}{speaks}
\DR@define@key{b}{character}{entry}{true}
\DR@define@key{c}{character}{namefont}{}
\DR@define@key{c}{character}{namecase}{}
\DR@define@key{c}{speaker}{font}{}
\DR@define@key{c}{speaker}{case}{} %% Valori permessi ` ', \MakeLowercase, MakeUppercase
\DR@define@key{c}{speaker}{del}{}
\DR@define@key{c}{speaker}{prelabel}{}
\DR@define@key{c}{speaker}{postlabel}{}
\DR@define@key{L}{speaker}{labelwidth}{\@tempdima}

\newcommand\dramaphantom[2][0pt]{%
  \settowidth{\@tempdimb}{#2}%
  \addtolength{\@tempdimb}{\dimexpr-\DR@speaker@labelwidth+\labelwidth-#1\relax}
  \hskip\@tempdimb}
\newcommand\phantomspeaker[1]{{\DR@speaker{#1}}\hskip-\labelwidth}

\newcommand\DR@character@label{%
  \noexpand\DR@setvalues{character}%
  {\noexpand\DR@character@namefont \noexpand\DR@character@namecase{\DR@character@dirname}}\noexpand\xspace
}


%% Ho temporaneamente modificato \@speaker e \DR@speaker, in modo che eventuali 'direzioni' che seguono
%% immediatamente il parlante siano composte *fuori* da \item[]. Questo è assolutamente necssario per
%% mantenere il contenuto di \item[] su una sola riga. Tuttavia, a parte l'ineleganza della soluzione,
%% il problema opposto si riproporrà non appena vorrò passare allo stile 'centrato'.
\newcommand\DR@speaker[1]{%
  \DR@setvalues{speaker}%
  \DR@speaker@prelabel%
%  \settowidth{\@tempdimb}{\strut\DR@speaker@font\DR@speaker@case{#1}\DR@speaker@del\@ifmtarg{#2}{}{\ #2}\strut}%
%  \ifdim\@tempdimb>\dimexpr\textwidth-\leftmargin-\rightmargin+\labelwidth+\labelsep\relax
%    \setlength{\@tempdimb}{\dimexpr\textwidth-\leftmargin-\rightmargin+\labelwidth+\labelsep\relax}
%  \fi
%   \parbox{\@tempdimb}{\strut\DR@speaker@font\DR@speaker@case{#1}\DR@speaker@del\@ifmtarg{#2}{}{\ #2}\strut}%
  \DR@speaker@font\DR@speaker@case{#1}\DR@speaker@del%\@ifmtarg{#2}{}{\unskip\relax\ #2\hskip\DR@drama@labelsep}
  \DR@speaker@postlabel
}
\def\@speaker#1[#2]{%
  \settowidth{\@tempdima}{\DR@speaker{#1}{#2}}%
  \DR@setvalues{speaker}%
%   \item[\hb@xt@\DR@speaker@labelwidth{\DR@speaker{#1}{#2}}]\DR@drama@postitem
  \item[\DR@speaker{#1}]\@ifmtarg{#2}{}{\hskip-\DR@drama@labelsep\hskip 0pt plus 4pt\ #2\hskip\DR@drama@labelsep}\DR@drama@postitem
}

\newcommand\DR@character[2]{%
  \def\DR@character@speakername{#1}
    \global\expandafter\edef\csname#2\endcsname{% \global is needed for CharacterGroup
      \DR@character@label}%                     % \edef because expansion must be at declaration time
    \global\expandafter\def\csname#2\DR@character@speaksadd\endcsname{%
      \def\DR@drama@postitem{\DR@pidefault}% here, because otherwise it shields \@speaker{#1}...
      \@ifstar{\def\DR@drama@postitem{}\@ifnextchar[{\@speaker{#1}}{\@speaker{#1}[]}}%
        {\@ifnextchar[{\@speaker{#1}}{\@speaker{#1}[]}}}%
  \ifDR@character@entry
    \if@cglist
      \stepcounter{g\DRroman{character}}
      \global\expandafter\edef\csname gpersona\Roman{character}\DRroman{g\DRroman{character}}\endcsname{%
        \DR@dramper@entry}
    \else
      \stepcounter{character}
      \global\expandafter\edef\csname persona\DRroman{character}\endcsname{%
        \DR@dramper@entry}
    \fi
  \fi
}
\newcommand\Character[3][entry=false]{%
  {
    \DR@setvalues{character}
    \setkeys{character}{#1}
    \DR@character{#2}{#3}
  }
}

\newenvironment{CharacterGroup}[1]{%
  \@cglisttrue
  \stepcounter{character}
  \newcounter{g\DRroman{character}}
  \grouplist{#1}
}{\@cglistfalse}
\newsavebox{\tbox}
\newcommand\grouplist[1]{%
    \global\expandafter\def\csname persona\DRroman{character}\endcsname{%
    \settowidth{\DR@dramatis@castwidth}{\DR@dramatis@descfont #1}
    \DR@checkwidth
    \begin{lrbox}{\tbox}
      \begin{minipage}[c]{\DR@dramatis@charwidth}
        \list{}{%
          \itemindent=\z@%
          \leftmargin=\z@% same indentation of outer list
          \itemsep\DR@dramatis@itemsep%
          \parsep\DR@dramatis@parsep}%
        \dogrouplist
        \endlist
      \end{minipage}
    \end{lrbox}
    \parbox{\DR@dramatis@charwidth}{\usebox{\tbox}}%
    \parbox{\DR@dramatis@parenwidth}{$\left.\rule{0pt}{\ht\tbox}\right\}$}
    \parbox{\DR@dramatis@castwidth}{\DR@dramatis@headfont #1\strut}
    \global\setlength{\DR@dramatis@charwidth}{\z@}
  }
}
\newcommand\DR@checkwidth{
  \@tempcntb\z@
  \@whilenum\value{g\DR@roman{\@tempcnta}}>\@tempcntb\do{%
    \advance\@tempcntb\@ne
    \settowidth{\@tempdima}{\@nameuse{gpersona\@Roman{\@tempcnta}\DR@roman{\@tempcntb}}}%
    \ifdim\@tempdima>\DR@dramatis@charwidth%
      \global\setlength{\DR@dramatis@charwidth}{\@tempdima}%
    \fi%
  }
  \@tempdima=\dimexpr\DR@dramatis@charwidth+\DR@dramatis@parenwidth+\DR@dramatis@castwidth+%
    \DR@dramatis@leftmargin+\DR@dramatis@rightmargin+5pt\relax
  \ifdim\@tempdima>\dimexpr\textwidth% why?
    \PackageWarning{dramatist}{\DR@checkcgwwarning}
    \DR@dramatis@castwidth=\dimexpr\textwidth-\DR@dramatis@parenwidth-\DR@dramatis@charwidth-%
      \DR@dramatis@rightmargin-\DR@dramatis@leftmargin-5pt\relax
  \fi
}
\newcommand{\dogrouplist}{%
  \@tempcntb\z@
  \@whilenum\value{g\DR@roman{\@tempcnta}}>\@tempcntb\do{%
    \advance\@tempcntb\@ne
    \item\@nameuse{gpersona\@Roman{\@tempcnta}\DR@roman{\@tempcntb}}\strut%
  }%
}
\newcommand*\speaker{%
  \def\DR@drama@postitem{\DR@pidefault}%
  \@ifstar{\def\DR@drama@postitem{}\@xspeaker}{\@xspeaker}%
}
\newcommand*\@xspeaker[2][]{%
  \@speaker{#2}[#1]%
}
\newcommand*\character[1]{%
  \DR@setvalues{character}%
  {\DR@character@namefont\DR@character@namecase{#1}}\xspace%
}
%%---------------------------------------------------------------------------------
%% Dramatis personae
\DR@define@key{l}{dramatis}{leftmargin}{0pt}
\DR@define@key{l}{dramatis}{rightmargin}{0pt}
\DR@define@key{l}{dramatis}{indent}{0pt}
\DR@define@key{l}{dramatis}{itemsep}{0pt}
\DR@define@key{l}{dramatis}{topsep}{0pt}
\DR@define@key{l}{dramatis}{parsep}{0pt}
\DR@define@key{l}{dramatis}{partopsep}{0pt}
\DR@define@key{l}{dramatis}{charwidth}{0pt}
\DR@define@key{l}{dramatis}{castwidth}{0pt}
\DR@define@key{l}{dramatis}{parenwidth}{15pt}
\DR@define@key{c}{dramatis}{rolecase}{}
\DR@define@key{c}{dramatis}{rolefont}{}
\DR@define@key{c}{dramatis}{descfont}{}
\DR@define@key{c}{dramatis}{actorfont}{}
\DR@define@key{c}{dramatis}{headfont}{}
\DR@define@key{c}{dramatis}{dasep}{}
\DR@define@key{c}{dramatis}{titlefont}{}
\DR@define@key{c}{dramatis}{titlename}{}
\DR@define@key{c}{dramatis}{pagestyle}{empty}
\DR@define@key{l}{dramatis}{beforeskip}{0pt}
\DR@define@key{l}{dramatis}{afterskip}{0pt}

\newcommand\DR@dramper@entry{%
  {\noexpand\DR@dramatis@rolefont\noexpand\DR@dramatis@rolecase{\DR@character@role}}%
  \ifx\DR@character@desc\relax\else\DR@character@rdsep\fi%
  {\noexpand\DR@dramatis@descfont\DR@character@desc}%
  \noexpand\DR@dramatis@dasep%
  {\noexpand\DR@dramatis@actorfont\DR@character@actor}}

\newcommand\drampermark[1]{}
\newcommand{\printcasttitle}{\centering\DR@dramatis@titlefont \DR@dramatis@titlename}
\def\castheadstart{\vspace*{\DR@dramatis@beforeskip}}
\def\aftercasttitle{\par\nobreak\vskip\DR@dramatis@afterskip}
\newcommand{\DramPer}{%
  \DR@setvalues{dramatis}%
  \@ifundefined{if@openright}{\clearpage}{%
    \if@openright\cleardoublepage\else\clearpage\fi}
  \secdef\DR@dramper\DR@sdramper}
\newcommand\DR@dramper[1][]{%
  \phantomsection
  \addcontentsline{toc}{chapter}{\DR@dramatis@titlename}
  \drampermark{\DR@dramatis@titlename}
  \DR@dramperhead{#1}}
\newcommand\DR@sdramper[1][]{%
  \DR@dramperhead{#1}}
\newcommand\DR@dramperhead[1]{
  \thispagestyle{\DR@dramatis@pagestyle}
  \castheadstart
  {\printcasttitle #1
  \aftercasttitle}
  \begin{list}{}{%
    \leftmargin\DR@dramatis@leftmargin%
    \rightmargin\DR@dramatis@rightmargin%
    \topsep\DR@dramatis@topsep%
    \partopsep\DR@dramatis@partopsep%
    \itemsep\DR@dramatis@itemsep%
    \parsep\DR@dramatis@parsep%
    }
  \dodramperlist
  \end{list}
}
\newcommand{\dodramperlist}{%
  \@tempcnta\z@
  \@whilenum\c@character >\@tempcnta\do{%
    \advance\@tempcnta\@ne
  \item\@nameuse{persona\DR@roman{\@tempcnta}}\strut%
  }%
}
%%-----------------------------------------------------------------
%% Stage
\DR@define@key{l}{stage}{leftmargin}{0pt}
\DR@define@key{l}{stage}{rightmargin}{0pt}
\DR@define@key{l}{stage}{topsep}{0pt}
\DR@define@key{l}{stage}{partopsep}{0pt}
\DR@define@key{l}{stage}{parsep}{0pt}
\DR@define@key{l}{stage}{itemsep}{0pt}
\DR@define@key{c}{stage}{font}{}
\DR@define@key{c}{stage}{justification}{}
\DR@define@key{c}{stage}{rightdelimiter}{}
\DR@define@key{c}{stage}{leftdelimiter}{}

\newenvironment{DR@stage@display}{%
      \list{}{%
      \leftmargin\DR@stage@leftmargin%
      \rightmargin\DR@stage@rightmargin%
      \topsep\DR@stage@topsep%
      \partopsep\DR@stage@partopsep%
      \parsep\DR@stage@parsep%
      \itemsep\DR@stage@itemsep%
      }
      \DR@stage@justification%
      \DR@stage@font%
      \item[]
      \DR@stage@leftdelimiter}{%
      \DR@stage@rightdelimiter%
      \endlist
}
\newcommand\DR@stage@inline[1]{%
  \DR@stage@leftdelimiter{\DR@stage@font#1}\DR@stage@rightdelimiter
}

\newenvironment{Settings}[1][]{%
    \DR@setvalues{settings}
    \setkeys{stage}{#1}
    \DR@stage@display
  }{%
    \endDR@stage@display
}
\newcommand\settings[2][]{%
  {
    \DR@setvalues{settings}
    \setkeys{stage}{#1}
    \DR@stage@display#2
    \endDR@stage@display
  }
}

\newcommand\set[2][]{%
  {
    \DR@setvalues{set}
    \setkeys{stage}{#1}
    \DR@stage@display#2
    \endDR@stage@display
  }
}

\newcommand\direction[2][]{%
  {%
    \DR@setvalues{direction}
    \setkeys{stage}{#1}
    \if@firstdirection\item\relax\fi
    \DR@stage@display#2~%
    \endDR@stage@display
    \if@firstdirection\par\vskip\DR@stage@topsep\fi
    \global\@firstdirectionfalse
  }%
}

\newcommand\delivery[2][]{%
  {%
    \DR@setvalues{delivery}%
    \setkeys{stage}{#1}%
    \DR@stage@inline{#2}%
  }%
}
%%-------------------------------------------------------------------------------
%% Languages
\@ifpackageloaded{babel}{
  \addto\captionsitalian{%
    \def\actname{Atto}
    \def\scenename{Scena}
    \def\drampername{Personaggi}
  }
  \addto\captionsgerman{%
    \def\actname{Akt}
    \def\scenename{Szene}
    \def\drampername{Personen}
  }
  \addto\captionsfrench{%
    \def\actname{Acte}
    \def\scenename{Scene}
    \def\drampername{Personnages}
  }
  \addto\captionsspanish{%
    \def\actname{Acto}
    \def\scenename{Escena}
    \def\drampername{Personajes}
  }
}{}

%%-------------------------------------------------------------------------------
%% Configuration
\presetkeys{drama}{
  leftmargin,
  rightmargin,
  speakswidth,
  speaksindent,
  speechskip,
  parsep,
  labelsep,
  speakerlabel,
  font,
  postitem,
}{}
\presetkeys{sections}{
  namefont,
  numfont,
  titlefont,
  name,
  sep,
  pagestyle,
  beforeskip,
  afterskip,
}{}
\presetkeys{character}{
  dirname,
  speakername,
  role,
  desc,
  actor,
  rdsep,
  speaksadd,
  entry,
  namefont,
  namecase,
}{}
\presetkeys{speaker}{
  font,
  case,
  del,
  prelabel,
  postlabel,
  labelwidth,
}{}
\presetkeys{dramatis}{
  leftmargin,
  rightmargin,
  indent,
  itemsep,
  topsep,
  parsep,
  partopsep,
  charwidth,
  castwidth,
  parenwidth,
  rolecase,
  rolefont,
  descfont,
  actorfont,
  headfont,
  dasep,
  titlefont,
  titlename=\drampername,
  pagestyle,
  beforeskip,
  afterskip,
}{}
\presetkeys{stage}{
  leftmargin,
  rightmargin,
  topsep,
  partopsep,
  parsep,
  itemsep,
  font,
  justification,
  rightdelimiter,
  leftdelimiter,
}{}



% \DR@define@defaults{drama}{%
%   \DR@drama@speaksindent=-\leftmargin%
%   \DR@drama@speechskip\itemsep%
%   \DR@drama@labelsep\labelsep%
% }
% \DR@define@defaults{versedrama}{%
% }
\DR@define@defaults{act}{%
  \def\DR@sections@namefont{\large\scshape}%
  \def\DR@sections@name{\actname}%
  \def\DR@sections@beforeskip{\baselineskip}%
  \def\DR@sections@afterskip{\baselineskip}%
}
\DR@define@defaults{scene}{%
  \def\DR@sections@namefont{\scshape}%
  \def\DR@sections@name{\scenename}%
  \def\DR@sections@afterskip{2\baselineskip}%
}
% \DR@define@defaults{character}{%
%   \def\DR@character@font{\normalfont\scshape}% \normalfont because \bfseries+\scshape=\bfseries
% }
% \DR@define@defaults{speaker}{%
%   \def\DR@speaker@labelwidth{\@tempdima}%
%   \def\DR@speaker@font{\scshape}%
%   \def\DR@speaker@del{:}%
% }
% \DR@define@defaults{dramatis}{%
%   \def\DR@dramatis@rolefont{\scshape}%
%   \DR@dramatis@leftmargin\z@%
%   \DR@dramatis@rightmargin\z@%
%   \def\DR@dramatis@titlename{Dramatis Person\ae}%
%   \def\DR@dramatis@titlefont{\scshape\Large}%
%   \def\DR@dramatis@dasep{\hfill}%
% }
% \DR@define@defaults{settings}{%
%   \def\DR@stage@font{\itshape}%
% }
% \DR@define@defaults{direction}{%
%   \DR@stage@topsep\topsep%
%   \def\DR@stage@font{\itshape}%
% }
% \DR@define@defaults{delivery}{%
%   \def\DR@stage@font{\itshape}%
%   \def\DR@stage@leftdelimiter{(}%
%   \def\DR@stage@rightdelimiter{)}%
% }
% \DR@define@defaults{set}{%
%   \def\DR@stage@justification{\centering}%
%   \def\DR@stage@font{\itshape}%
% }
\AtEndOfPackage{
  \InputIfFileExists{\DR@stylefile.dst}
    {\PackageInfo{dramatist}{Load `\DR@stylefile' style.dst}}
    {\input{modern.dst}
     \PackageWarning{dramatist}{File \DR@stylefile.dst not found. Load default `modern' style}}
}
\AtBeginDocument{
  \@ifpackageloaded{poemscol}{\@poemscoltrue}{\@poemscolfalse}
  \if@poemscol
    \setlength\verse@leftmargin{1sp}
    \patchcmd{\pmclverse}{\item[]}{%
      \item[]
      \labelsep=\DR@drama@labelsep
      \labelwidth=\dimexpr\DR@drama@speakswidth-\leftmargini+\leftmarginii\relax
      \itemsep\DR@drama@speechskip
      }{}{}
  \else
    \apptocmd{\verse}{%
      \labelsep=\DR@drama@labelsep
      \labelwidth=\DR@drama@speakswidth
      \itemsep\DR@drama@speechskip
    }{}{}%
  \fi%
  \setkeys+{dramatis,drama,sections,character,speaker,stage}{}
}

%%-------------------------------------------------------------------------------
%% Errors and Warnings
\newcommand\DR@lnpwarning{The option `numbering' is meaningless outside the%
                            `versedrama' environment}
\newcommand\DR@checkcgwwarning{Dimension too large}
\newcommand\DR@inputfilewarning{\PackageWarningNoLine{dramatist}{^^J^^J%
********************************************************^^J%
* No Configuration file found, using default settings. *^^J%
********************************************************^^J%
}}
\newcommand\DR@foundfile{\PackageWarningNoLine{dramatist}{^^J^^J%
*******************************************^^J%
* Using Configuration file dramatist.cfg. *^^J%
*******************************************^^J%
}}
\InputIfFileExists{\jobname.cfg}{\@foundfile}{\DR@inputfilewarning}
\endinput
%%
%% End of file `dramatist.sty'.
